<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barcode Scanner PWA with Big DB</title>
<style>
body { margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:black; color:white; font-family:sans-serif; text-align:center; }
#video { width:100%; max-height:120px; object-fit:cover; background:#222; }
#result { margin-top:10px; font-size:1.2em; }
.btn-row { margin-top:10px; display:flex; gap:10px; justify-content:center; }
button { padding:10px 20px; font-size:1em; border:none; border-radius:8px; cursor:pointer; color:white; }
#toggleBtn { background:#28a745; } #toggleBtn.off { background:#dc3545; }
#flashBtn { background:#007bff; } #flashBtn.on { background:#ffc107; color:black; }
#list { margin-top:10px; max-height:150px; overflow:auto; text-align:left; width:90%; border:1px solid #555; padding:5px; }
.success { color:#00ff55; }
.warning { color:#ffc107; }
</style>
</head>
<body>
<video id="video" autoplay playsinline></video>
<div id="result">Scan a barcode...</div>
<div class="btn-row">
  <button id="toggleBtn">Start Camera</button>
  <button id="flashBtn">Flash Off</button>
</div>
<div id="list"></div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const video=document.getElementById('video');
const result=document.getElementById('result');
const toggleBtn=document.getElementById('toggleBtn');
const flashBtn=document.getElementById('flashBtn');
const listDiv=document.getElementById('list');

let stream=null, scannerRunning=false, stopZXing=null, track=null, flashOn=false;

// -------- IndexedDB setup ----------
let localDB, bigDB;

// Local DB = scanned barcodes
const localRequest=indexedDB.open("LocalScannedDB",1);
localRequest.onerror=e=>console.error("LocalDB error",e);
localRequest.onsuccess=e=>{ localDB=e.target.result; displayAll(); };
localRequest.onupgradeneeded=e=>{
  localDB=e.target.result;
  if(!localDB.objectStoreNames.contains("barcodes")){
    localDB.createObjectStore("barcodes",{keyPath:"code"});
  }
};

// Big DB = reference barcodes (preloaded or large)
const bigRequest=indexedDB.open("BigBarcodeDB",1);
bigRequest.onerror=e=>console.error("BigDB error",e);
bigRequest.onsuccess=e=>{ bigDB=e.target.result; console.log("BigDB ready"); preloadBigDB(); };
bigRequest.onupgradeneeded=e=>{
  bigDB=e.target.result;
  if(!bigDB.objectStoreNames.contains("barcodes")){
    bigDB.createObjectStore("barcodes",{keyPath:"code"});
  }
};

// Preload BigDB with example barcodes (can be replaced with real data)
function preloadBigDB(){
  const codes=["12345678","98765432","11112222","22223333","33334444"];
  const tx=bigDB.transaction("barcodes","readwrite");
  const store=tx.objectStore("barcodes");
  codes.forEach(c=>{
    store.put({code:c});
  });
}

// -------- DB helpers ----------
function saveLocalBarcode(code){
  const tx=localDB.transaction("barcodes","readwrite");
  tx.objectStore("barcodes").put({code,date:new Date()});
  displayAll();
}

function displayAll(){
  const tx=localDB.transaction("barcodes","readonly");
  const store=tx.objectStore("barcodes");
  const req=store.getAll();
  req.onsuccess=()=>{ listDiv.innerHTML=req.result.map(r=>r.code).join("<br>"); };
}

function showMessage(msg,cls){ result.textContent=msg; result.className=cls; }

// -------- Barcode Validation ----------
function isValidBarcode(code){ return /^[0-9]{8,13}$/.test(code); }

// Multi-frame check
let lastDetected=null;
let detectCount=0;
const FRAME_THRESHOLD=2;

function checkAndSave(code){
  if(!isValidBarcode(code)) return;
  if(code===lastDetected){ detectCount++; } else { lastDetected=code; detectCount=1; }
  if(detectCount>=FRAME_THRESHOLD){
    detectCount=0; lastDetected=null;
    // check in BigDB
    const tx=bigDB.transaction("barcodes","readonly");
    const store=tx.objectStore("barcodes");
    const req=store.get(code);
    req.onsuccess=()=>{
      if(req.result){
        showMessage(`Barcode exists in reference DB: ${code}`,"warning");
      } else {
        saveLocalBarcode(code);
        showMessage(`New barcode saved: ${code}`,"success");
      }
    };
  }
}

// -------- Camera & Scanner ----------
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment", width:1280, height:720}});
    video.srcObject=stream; track=stream.getVideoTracks()[0];
  }catch(err){ console.error(err); showMessage("Camera access failed.","warning"); }
}

async function startScanner(){
  if('BarcodeDetector' in window){
    const detector=new BarcodeDetector({formats:['code_128','ean_13','upc_a']});
    const scan=async()=>{
      if(!scannerRunning) return;
      try{
        const barcodes=await detector.detect(video);
        if(barcodes.length>0){ checkAndSave(barcodes[0].rawValue); navigator.vibrate?.(80); }
      }catch(e){}
      requestAnimationFrame(scan);
    };
    scan();
  } else {
    const codeReader=new ZXing.BrowserMultiFormatReader();
    stopZXing=codeReader.decodeFromVideoDevice(null,'video',(res,err)=>{
      if(res){ checkAndSave(res.text); navigator.vibrate?.(80); }
    });
  }
}

function stopCamera(){
  if(stream){ stream.getTracks().forEach(t=>t.stop()); stream=null; video.srcObject=null; }
  if(stopZXing){ stopZXing(); stopZXing=null; }
  track=null;
}

// -------- Flash ----------
async function toggleFlash(){
  if(!track) return;
  const cap=track.getCapabilities();
  if(!cap.torch){ alert("Flash not supported"); return; }
  flashOn=!flashOn;
  try{ await track.applyConstraints({advanced:[{torch:flashOn}]}); flashBtn.textContent=flashOn?"Flash On":"Flash Off"; flashBtn.classList.toggle("on",flashOn); }
  catch(err){ console.error(err); }
}

// -------- Button Events ----------
toggleBtn.addEventListener('click',async()=>{
  if(scannerRunning){ scannerRunning=false; stopCamera(); toggleBtn.textContent="Start Camera"; toggleBtn.classList.remove("off"); }
  else{ scannerRunning=true; await startCamera(); startScanner(); toggleBtn.textContent="Stop Camera"; toggleBtn.classList.add("off"); }
});
flashBtn.addEventListener('click',toggleFlash);

</script>
</body>
</html>
