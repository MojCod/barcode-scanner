<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Barcode Scanner PWA with DB (Filtered)</title>
<style>
  body { margin:0; display:flex; flex-direction:column; justify-content:center; align-items:center; height:100vh; background:black; color:white; font-family:sans-serif; text-align:center; }
  #video { width:100%; max-height:120px; object-fit:cover; background:#222; }
  #result { margin-top:10px; font-size:1.2em; }
  .btn-row { margin-top:10px; display:flex; gap:10px; justify-content:center; }
  button { padding:10px 20px; font-size:1em; border:none; border-radius:8px; cursor:pointer; color:white; }
  #toggleBtn { background:#28a745; } #toggleBtn.off { background:#dc3545; }
  #flashBtn { background:#007bff; } #flashBtn.on { background:#ffc107; color:black; }
  #list { margin-top:10px; max-height:150px; overflow:auto; text-align:left; width:90%; border:1px solid #555; padding:5px; }
  .error { color:#ff4444; }
  .success { color:#00ff55; }
</style>
</head>
<body>
<video id="video" autoplay playsinline></video>
<div id="result">Scan a barcode...</div>
<div class="btn-row">
  <button id="toggleBtn">Start Camera</button>
  <button id="flashBtn">Flash Off</button>
</div>
<div id="list"></div>

<script src="https://unpkg.com/@zxing/library@latest"></script>
<script>
const video=document.getElementById('video');
const result=document.getElementById('result');
const toggleBtn=document.getElementById('toggleBtn');
const flashBtn=document.getElementById('flashBtn');
const listDiv=document.getElementById('list');

let stream=null, scannerRunning=false, stopZXing=null, track=null, flashOn=false;

// -------- IndexedDB setup ----------
let db;
const request=indexedDB.open("BarcodeDB",1);
request.onerror=e=>console.error("DB error",e);
request.onsuccess=e=>{
  db=e.target.result;
  console.log("DB ready");
  displayAll();
};
request.onupgradeneeded=e=>{
  db=e.target.result;
  if(!db.objectStoreNames.contains("barcodes")){
    db.createObjectStore("barcodes",{keyPath:"code"});
  }
};

// -------- DB helpers ----------
function saveBarcode(code){
  const tx=db.transaction("barcodes","readwrite");
  const store=tx.objectStore("barcodes");
  const getReq=store.get(code);
  getReq.onsuccess=()=>{
    if(getReq.result){
      showMessage(`Barcode already scanned: ${code}`,"error");
    } else {
      store.add({code,date:new Date()});
      showMessage(`Saved: ${code}`,"success");
      displayAll();
    }
  };
}

function displayAll(){
  const tx=db.transaction("barcodes","readonly");
  const store=tx.objectStore("barcodes");
  const req=store.getAll();
  req.onsuccess=()=>{ listDiv.innerHTML=req.result.map(r=>r.code).join("<br>"); };
}

function showMessage(msg,cls){ result.textContent=msg; result.className=cls; }

// -------- Barcode Validation ----------
function isValidBarcode(code){
  return /^[0-9]{8,13}$/.test(code); // فقط عدد، طول 8 تا 13
}

// Multi-frame check
let lastDetected=null;
let detectCount=0;
const FRAME_THRESHOLD=2; // تعداد فریم‌های تایید قبل از ثبت

function checkAndSave(code){
  if(!isValidBarcode(code)) return;
  if(code === lastDetected){
    detectCount++;
  } else {
    lastDetected=code;
    detectCount=1;
  }
  if(detectCount >= FRAME_THRESHOLD){
    saveBarcode(code);
    detectCount=0;
    lastDetected=null;
  }
}

// -------- Camera & Scanner ----------
async function startCamera(){
  try{
    stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment", width:1280, height:720}});
    video.srcObject=stream;
    track=stream.getVideoTracks()[0];
  }catch(err){
    console.error("Camera error:",err);
    showMessage("Camera access failed.","error");
  }
}

async function startScanner(){
  if('BarcodeDetector' in window){
    const detector=new BarcodeDetector({formats:['code_128','ean_13','upc_a']});
    const scan=async()=>{
      if(!scannerRunning) return;
      try{
        const barcodes=await detector.detect(video);
        if(barcodes.length>0){
          checkAndSave(barcodes[0].rawValue);
          navigator.vibrate?.(80);
        }
      }catch(e){}
      requestAnimationFrame(scan);
    };
    scan();
  } else {
    const codeReader=new ZXing.BrowserMultiFormatReader();
    stopZXing=codeReader.decodeFromVideoDevice(null,'video',(res,err)=>{
      if(res){
        checkAndSave(res.text);
        navigator.vibrate?.(80);
      }
    });
  }
}

function stopCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null; video.srcObject=null;
  }
  if(stopZXing){
    stopZXing(); stopZXing=null;
  }
  track=null;
}

// -------- Flash ----------
async function toggleFlash(){
  if(!track) return;
  const cap=track.getCapabilities();
  if(!cap.torch){ alert("Flash not supported"); return; }
  flashOn=!flashOn;
  try{
    await track.applyConstraints({advanced:[{torch:flashOn}]});
    flashBtn.textContent=flashOn?"Flash On":"Flash Off";
    flashBtn.classList.toggle("on",flashOn);
  }catch(err){console.error(err);}
}

// -------- Button Events ----------
toggleBtn.addEventListener('click',async()=>{
  if(scannerRunning){
    scannerRunning=false;
    stopCamera();
    toggleBtn.textContent="Start Camera";
    toggleBtn.classList.remove("off");
  } else {
    scannerRunning=true;
    await startCamera();
    startScanner();
    toggleBtn.textContent="Stop Camera";
    toggleBtn.classList.add("off");
  }
});

flashBtn.addEventListener('click',toggleFlash);

</script>
</body>
</html>
